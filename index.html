<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Escapa de Victambo - v2.0</title>
<style>
    html,body{ margin:0; padding:0; background:#000; color:#fff; font-family:sans-serif; overflow:hidden; touch-action:none; }
    #game-container { position:relative; width:100vw; height:100vh; overflow:hidden; }
    #world { position:absolute; width:2000px; height:2000px; background:#1a1a1a; }
    
    /* Paredes y Habitaciones */
    .room { position:absolute; background:#333; border:8px solid #444; box-sizing:border-box; }
    
    #player { 
        position:absolute; width:30px; height:30px; background:#00ffcc; 
        border-radius:50%; z-index:10; box-shadow:0 0 15px #00ffcc;
        transition: transform 0.1s;
    }
    
    #victambo { 
        position:absolute; width:50px; height:50px; background:#f00; 
        border-radius:50%; z-index:9; display:flex; align-items:center; 
        justify-content:center; font-size:30px; box-shadow:0 0 20px #f00;
    }

    .key { 
        position:absolute; width:25px; height:25px; background:gold; 
        border-radius:50%; display:flex; align-items:center; 
        justify-content:center; font-size:15px; z-index:5; 
        box-shadow:0 0 10px gold;
    }

    /* UI */
    #hud { position:fixed; top:20px; left:20px; background:rgba(0,0,0,0.7); padding:15px; border-radius:10px; z-index:100; border:1px solid #555; }
    #joystick { position:fixed; bottom:40px; left:40px; width:100px; height:100px; background:rgba(255,255,255,0.1); border-radius:50%; z-index:100; }
    #stick { position:absolute; top:25px; left:25px; width:50px; height:50px; background:rgba(255,255,255,0.3); border-radius:50%; }
    #interact { position:fixed; bottom:50px; right:40px; width:80px; height:80px; background:#e63946; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:30px; z-index:100; border:4px solid #fff; }
    #msg-overlay { position:fixed; top:20%; width:100%; text-align:center; font-size:24px; pointer-events:none; opacity:0; transition:0.3s; z-index:110; text-shadow:2px 2px #000; }
    #fade { position:fixed; inset:0; background:#000; opacity:0; pointer-events:none; transition:2s; z-index:1000; }
</style>
</head>
<body>

<div id="game-container">
    <div id="world">
        <div id="victambo"></div>
    </div>
</div>

<div id="hud">
     Llaves: <span id="keys-count">0</span> / 3<br>
    <span id="radar">Victambo: Acechando...</span>
</div>

<div id="msg-overlay"></div>
<div id="joystick"><div id="stick"></div></div>
<div id="interact"></div>
<div id="fade"></div>

<script>
/* CONFIGURACIN */
const world = document.getElementById('world');
const playerEl = document.createElement('div');
playerEl.id = 'player';
world.appendChild(playerEl);

const victEl = document.getElementById('victambo');
const rooms = [
    {x: 100, y: 100, w: 400, h: 400},
    {x: 600, y: 100, w: 400, h: 400},
    {x: 100, y: 600, w: 400, h: 400},
    {x: 600, y: 600, w: 500, h: 500} // Habitaci贸n de salida
];

const keysData = [
    {x: 200, y: 200, collected: false},
    {x: 800, y: 200, collected: false},
    {x: 200, y: 800, collected: false}
];

let player = { x: 250, y: 250, speed: 6 };
let victambo = { x: 800, y: 800, speed: 3, state: 'WAIT' };
let keysFound = 0;
let isGameOver = false;

/* GENERAR MUNDO */
rooms.forEach(r => {
    const div = document.createElement('div');
    div.className = 'room';
    div.style.left = r.x + 'px';
    div.style.top = r.y + 'px';
    div.style.width = r.w + 'px';
    div.style.height = r.h + 'px';
    world.appendChild(div);
});

keysData.forEach((k, i) => {
    const div = document.createElement('div');
    div.className = 'key';
    div.id = 'key-' + i;
    div.innerHTML = '';
    div.style.left = k.x + 'px';
    div.style.top = k.y + 'px';
    world.appendChild(div);
    k.el = div;
});

/* LGICA DE MOVIMIENTO Y COLISIN */
function canMoveTo(nx, ny) {
    // Verificar si est谩 dentro de alguna habitaci贸n
    return rooms.some(r => {
        return nx >= r.x && nx <= (r.x + r.w - 30) &&
               ny >= r.y && ny <= (r.y + r.h - 30);
    });
}

function showMsg(txt) {
    const m = document.getElementById('msg-overlay');
    m.innerText = txt;
    m.style.opacity = 1;
    setTimeout(() => m.style.opacity = 0, 2000);
}

/* CONTROLES (JOYSTICK) */
let moveX = 0, moveY = 0;
const joystick = document.getElementById('joystick');
const stick = document.getElementById('stick');

joystick.addEventListener('touchstart', e => handleJoy(e));
document.addEventListener('touchmove', e => handleJoy(e));
document.addEventListener('touchend', () => {
    moveX = 0; moveY = 0;
    stick.style.transform = `translate(0,0)`;
});

function handleJoy(e) {
    if (isGameOver) return;
    const rect = joystick.getBoundingClientRect();
    const touch = e.touches[0];
    const centerX = rect.left + rect.width/2;
    const centerY = rect.top + rect.height/2;
    const dx = touch.clientX - centerX;
    const dy = touch.clientY - centerY;
    const angle = Math.atan2(dy, dx);
    const dist = Math.min(Math.hypot(dx, dy), 40);
    
    stick.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
    moveX = Math.cos(angle) * player.speed;
    moveY = Math.sin(angle) * player.speed;
}

/* INTERACCIN (BOTN) */
document.getElementById('interact').addEventListener('touchstart', (e) => {
    e.preventDefault();
    if (isGameOver) return;

    // Recoger llaves
    keysData.forEach(k => {
        if (!k.collected && Math.hypot(player.x - k.x, player.y - k.y) < 60) {
            k.collected = true;
            k.el.style.display = 'none';
            keysFound++;
            document.getElementById('keys-count').innerText = keysFound;
            showMsg("隆Llave obtenida!");
        }
    });

    // Salida
    if (keysFound >= 3 && player.x > 600 && player.y > 600) {
        winGame();
    }
});

/* BUCLE DE JUEGO */
function update() {
    if (isGameOver) return;

    // Movimiento jugador con colisi贸n b谩sica
    let nextX = player.x + moveX;
    let nextY = player.y + moveY;
    if (canMoveTo(nextX, nextY)) {
        player.x = nextX;
        player.y = nextY;
    }

    // IA Victambo
    const distToPlayer = Math.hypot(player.x - victambo.x, player.y - victambo.y);
    if (distToPlayer < 300) {
        victambo.state = 'CHASE';
        document.getElementById('radar').innerText = "Victambo: 隆TE EST PERSIGUIENDO!";
        document.getElementById('radar').style.color = "#ff4d4d";
    } else {
        victambo.state = 'PATROL';
        document.getElementById('radar').innerText = "Victambo: Acechando...";
        document.getElementById('radar').style.color = "#fff";
    }

    if (victambo.state === 'CHASE') {
        const ang = Math.atan2(player.y - victambo.y, player.x - victambo.x);
        victambo.x += Math.cos(ang) * victambo.speed;
        victambo.y += Math.sin(ang) * victambo.speed;
    } else {
        victambo.x += Math.sin(Date.now()/500);
    }

    // Colisi贸n con Victambo
    if (distToPlayer < 40) loseGame();

    // Renderizado
    playerEl.style.left = player.x + 'px';
    playerEl.style.top = player.y + 'px';
    victEl.style.left = victambo.x + 'px';
    victEl.style.top = victambo.y + 'px';
    
    // C谩mara (centrada en jugador)
    world.style.transform = `translate(${-player.x + window.innerWidth/2}px, ${-player.y + window.innerHeight/2}px)`;

    requestAnimationFrame(update);
}

function loseGame() {
    isGameOver = true;
    document.getElementById('fade').style.opacity = 1;
    showMsg("Victambo te alcanz贸...");
    setTimeout(() => location.reload(), 3000);
}

function winGame() {
    isGameOver = true;
    document.getElementById('fade').style.opacity = 1;
    showMsg("隆HAS ESCAPADO DE LA CASA!");
    setTimeout(() => location.reload(), 4000);
}

showMsg("Busca las 3 llaves para abrir la salida");
update();
</script>
</body>
</html>
