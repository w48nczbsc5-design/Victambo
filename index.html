<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Victambo 3D: Control Total</title>
    <style>
        body { margin: 0; overflow: hidden; background: #fff; font-family: sans-serif; }
        
        /* UI de Estado */
        #ui { position: fixed; top: 10px; left: 10px; color: #333; z-index: 10; background: rgba(255,255,255,0.8); padding: 10px; border-radius: 8px; border: 1px solid #ccc; pointer-events: none; }
        #radar { color: red; font-weight: bold; display: none; margin-top: 5px; }

        /* Controles de Movimiento (Botones) */
        #controls-move { position: fixed; bottom: 20px; left: 20px; display: grid; grid-template-columns: repeat(3, 60px); grid-template-rows: repeat(2, 60px); gap: 5px; z-index: 100; }
        .btn { width: 60px; height: 60px; background: rgba(0,0,0,0.1); border: 2px solid #999; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #333; user-select: none; touch-action: none; }
        .btn:active { background: rgba(0,0,0,0.3); }
        #btn-up { grid-column: 2; }
        #btn-left { grid-column: 1; grid-row: 2; }
        #btn-down { grid-column: 2; grid-row: 2; }
        #btn-right { grid-column: 3; grid-row: 2; }

        /* Panel de C√°mara (√Årea t√°ctil derecha) */
        #camera-zone { position: fixed; top: 0; right: 0; width: 50%; height: 100%; z-index: 5; touch-action: none; }

        /* Botones de Acci√≥n */
        #actions { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 100; }
        .action-btn { width: 70px; height: 70px; border-radius: 50%; border: 3px solid #666; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 28px; }

        #start-screen { position: fixed; inset: 0; background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; text-align: center; }
        #overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; color: red; font-size: 40px; z-index: 1100; display: none; }
        #yt-player { position: absolute; top: -1000px; left: -1000px; }
    </style>
</head>
<body>

<div id="start-screen">
    <h1>VICTAMBO 3D</h1>
    <p>Usa los botones para caminar y desliza a la derecha para mirar.</p>
    <button id="play-btn" style="padding:15px 30px; font-size:20px; background:#000; color:#fff; border-radius:10px; border:none; cursor:pointer;">EMPEZAR</button>
</div>

<div id="ui">
    üîë LLAVES: <span id="count">0</span> / 5<br>
    <span id="floor-ui">PISO: PB</span>
    <div id="radar">‚ö†Ô∏è ORULA CERCA ‚ö†Ô∏è</div>
</div>

<div id="camera-zone"></div>

<div id="controls-move">
    <div class="btn" id="btn-up">‚ñ≤</div>
    <div class="btn" id="btn-left">‚óÄ</div>
    <div class="btn" id="btn-down">‚ñº</div>
    <div class="btn" id="btn-right">‚ñ∂</div>
</div>

<div id="actions">
    <div class="action-btn" id="btn-interact">üîë</div>
</div>

<div id="overlay">VICTAMBO TE ATRAP√ì</div>
<div id="yt-player"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
let scene, camera, renderer, player, monster, ytPlayer;
let keys = [], collected = 0;
let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
let isDead = false, apiReady = false;

// Rotaci√≥n de c√°mara
let yaw = 0, pitch = 0;
const sensitivity = 0.005;

// API YouTube para "Orula"
const tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
document.body.appendChild(tag);
function onYouTubeIframeAPIReady() {
    ytPlayer = new YT.Player('yt-player', {
        height: '0', width: '0', videoId: '44CwUMP38ok',
        playerVars: { 'autoplay': 1, 'loop': 1, 'playlist': '44CwUMP38ok' },
        events: { 'onReady': () => apiReady = true }
    });
}

document.getElementById('play-btn').addEventListener('click', () => {
    if(!apiReady) return alert("Cargando m√∫sica...");
    document.getElementById('start-screen').style.display = 'none';
    ytPlayer.setVolume(0);
    ytPlayer.playVideo();
    init();
    animate();
});

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0xffffff);

    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 1.4));

    // Pisos (Escala de grises)
    const floorY = [-10, 0, 10];
    const colors = [0xcccccc, 0xeeeeee, 0xffffff];
    floorY.forEach((y, i) => {
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshLambertMaterial({color: colors[i]}));
        floor.rotation.x = -Math.PI/2; floor.position.y = y;
        scene.add(floor);
    });

    player = new THREE.Object3D();
    player.position.set(0, 1.6, 20);
    scene.add(player);
    player.add(camera); // La c√°mara es los ojos del jugador

    // Victambo
    const tex = new THREE.TextureLoader().load('https://i.ibb.co/Xf7T4Bf/victor-mendivil.png');
    monster = new THREE.Sprite(new THREE.SpriteMaterial({map: tex}));
    monster.scale.set(4, 4, 1);
    monster.position.set(15, 1.5, -15);
    scene.add(monster);

    // Llaves
    const keyGeo = new THREE.TorusGeometry(0.3, 0.1, 8, 16);
    const keyMat = new THREE.MeshLambertMaterial({color: 0xd4af37});
    const pos = [{x:10,y:-8.5,z:10}, {x:-20,y:1.5,z:-15}, {x:20,y:1.5,z:10}, {x:-15,y:11.5,z:20}, {x:5,y:11.5,z:-5}];
    pos.forEach(p => {
        const k = new THREE.Mesh(keyGeo, keyMat);
        k.position.set(p.x, p.y, p.z);
        scene.add(k);
        keys.push(k);
    });

    setupControls();
}

function setupControls() {
    // Movimiento
    const bind = (id, setter) => {
        const el = document.getElementById(id);
        el.addEventListener('touchstart', (e) => { e.preventDefault(); setter(true); });
        el.addEventListener('touchend', (e) => { e.preventDefault(); setter(false); });
    };
    bind('btn-up', v => moveForward = v);
    bind('btn-down', v => moveBackward = v);
    bind('btn-left', v => moveLeft = v);
    bind('btn-right', v => moveRight = v);

    // C√°mara (Deslizar en zona derecha)
    const camZone = document.getElementById('camera-zone');
    let lastX, lastY;
    camZone.addEventListener('touchstart', e => {
        lastX = e.touches[0].clientX;
        lastY = e.touches[0].clientY;
    });
    camZone.addEventListener('touchmove', e => {
        const dx = e.touches[0].clientX - lastX;
        const dy = e.touches[0].clientY - lastY;
        yaw -= dx * sensitivity;
        pitch -= dy * sensitivity;
        pitch = Math.max(-Math.PI/3, Math.min(Math.PI/3, pitch));
        lastX = e.touches[0].clientX;
        lastY = e.touches[0].clientY;
    });

    // Interactuar
    document.getElementById('btn-interact').addEventListener('touchstart', (e) => {
        e.preventDefault();
        keys.forEach((k, i) => {
            if(player.position.distanceTo(k.position) < 4) {
                scene.remove(k); keys.splice(i, 1);
                collected++; document.getElementById('count').innerText = collected;
            }
        });
        if(Math.hypot(player.position.x, player.position.z) < 5) {
            if(player.position.y < 5) player.position.y += 10;
            else player.position.y = -8.4;
            document.getElementById('floor-ui').innerText = "PISO: " + (player.position.y < 0 ? "S√ìTANO" : player.position.y > 5 ? "ALTA" : "PB");
        }
    });
}

function animate() {
    if(isDead) return;
    requestAnimationFrame(animate);

    // Aplicar rotaci√≥n
    player.rotation.y = yaw;
    camera.rotation.x = pitch;

    // Moverse (Lento y controlado)
    const speed = 0.1;
    if(moveForward) player.translateZ(-speed);
    if(moveBackward) player.translateZ(speed);
    if(moveLeft) player.translateX(-speed);
    if(moveRight) player.translateX(speed);

    // Victambo e IA
    const d = player.position.distanceTo(monster.position);
    if(Math.abs(player.position.y - monster.position.y) < 5) {
        let vol = Math.max(0, Math.min(100, 100 - (d * 3.5)));
        if(ytPlayer.setVolume) ytPlayer.setVolume(vol);
        document.getElementById('radar').style.display = d < 15 ? 'block' : 'none';

        const dir = new THREE.Vector3().subVectors(player.position, monster.position).normalize();
        monster.position.add(dir.multiplyScalar(0.085));
        if(d < 1.8) {
            isDead = true;
            document.getElementById('overlay').style.display = 'flex';
            ytPlayer.stopVideo();
            setTimeout(() => location.reload(), 3000);
        }
    } else {
        if(ytPlayer.setVolume) ytPlayer.setVolume(0);
        document.getElementById('radar').style.display = 'none';
    }

    renderer.render(scene, camera);
}
</script>
</body>
</html>
